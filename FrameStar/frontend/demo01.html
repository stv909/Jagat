<!DOCTYPE html>
<html>
	<head>
		<title>Frame-Star Demo01</title>
		<script src="core/FrameStar.js"></script>
	</head>
	<body>
		<div id="starControl" style="width:100%; text-align:center">
			<input id="newStarContent" type="text" name="starContent" />
			<button onClick = "var elem = document.getElementById('newStarContent'); elem.focus(); elem.value = '';">
				X
			</button>
			<button onClick = "var elem = document.getElementById('newStarContent'); elem.focus(); createStar(elem.value);">
				Create Star
			</button>
		</div>

		<div id="globalOperations" style="width:100%; text-align:right;">
			<button onClick = "clearFrame();">
				Clear Frame
			</button>
			<br>
			<button onClick = "refreshFrame();">
				Refresh Frame
			</button>
		</div>

		<div style="width:100%;">
			<div style="float:left; width:15%;">
				<div id="selectionPanel">
					Selection:<br>
					<button id="selectedStar" onClick="clearSelection();">
					<button id="selectedStar_Edit" onClick="editStarContent();">
						E
					</button>
					<button id="selectedStar_ClearTags" onClick="clearStarTags(document.getElementById('selectedStar').value);">
						0
					</button>
					<button id="selectedStar_Delete" onClick="destroyStar(document.getElementById('selectedStar').value);">
						X
					</button>
				</div>
				<div>
					Star List:
				</div>
				<div id="starList">
				</div>
			</div>
			<div id="starField" style="float:right; width:85%; white-space:nowrap;">
			</div>
		</div>

		<script>
			var frame = new Frame();

			function createStar(content)
			{
				var newStar = frame.Star.create();
				newStar.content = content;
			}

			function destroyStar(starId)
			{
				if (!starId)
					return;
				frame.Star.destroy(starId);
			}

			function editStarContent()
			{
				var button = document.getElementById('selectedStar');
				var newContent = prompt("Enter new content:", button.textContent);
				frame.Star.getById(button.value).content = newContent;
				button.textContent = newContent;
			}

			function refreshTagsColors()
			{
				var selectionView = document.getElementById('selectedStar');

				var starListView = document.getElementById('starList');
				for (var i = 0; i < starListView.children.length; ++i)
				{
					var color = '#e0e0e0';
					if (selectionView.tags)
					{
						for (var j = 0; j < selectionView.tags.length; ++j)
						{
							if (selectionView.tags[j] === starListView.children[i].value)
							{
								color = '#0fbd0f';
								break;
							}
						}
					}
					starListView.children[i].style.backgroundColor = color;
				}
			}

			function clearStarTags(starId)
			{
				frame.Star.Tags.clear(starId);
				document.getElementById('selectedStar').tags = [];
				refreshTagsColors();
			}

			function clearSelection()
			{
				var selectionView = document.getElementById('selectedStar');
				selectionView.value = null;
				selectionView.textContent = '';
				selectionView.tags = null;
				refreshTagsColors();
			}

			// TODO: divide refreshFrame on refreshStarList and refreshStarField functions, make autocalls

			function refreshFrame()
			{
				clearSelection();

				var stars = frame.Star.getArray();

				// >> // fill star field

				// clear div content
				var starFieldView = document.getElementById('starField');
				while (starFieldView.firstChild)
				{
					starFieldView.removeChild(starFieldView.firstChild);
				}

				// sort stars by vertical lines
				var starLines = [];
				// first line - stars with no tags
				// second line - stars have tags only from first line
				// third line - stars have tags only from first or second line
				// etc.
				var starsToTest = stars;
				while (starsToTest.length > 0)
				{
					var priorLength = starsToTest.length;
					var currentLine = [];
					var concreteStars = [];
					for (var i = 0; i < starsToTest.length; ++i)
					{
						var star = starsToTest[i];
						var isConcrete = false;
						for (var t = 0; t < star.tags.length; ++t)
						{
							var tag = star.tags[t];
							var tagFound = false;
							for (var j = 0; j < starsToTest.length; ++j)
							{
								if (tag === starsToTest[j].id)
								{
									tagFound = true;
									break;
								}
							}
							if (tagFound)
							{
								isConcrete = true;
								break;
							}
						}
						if (isConcrete)
						{
							concreteStars.push(star);
						}
						else
						{
							currentLine.push(star);
						}
					}
					starLines.push(currentLine);
					starsToTest = concreteStars;
					if (priorLength === starsToTest.length)
					{
						console.log('WARNING: endless loop detected. force break.');
						break;
					}
				}

				// sort each lines by horizontal order

				// fill div with sorted content

				var toggleStarSelection = function()
				{
					var selectionView = document.getElementById('selectedStar');
					var newSelectionId = this.value;
					selectionView.value = newSelectionId;
					selectionView.textContent = this.textContent;
					selectionView.tags = this.tags;
					refreshTagsColors();
				}

				var getReadableTagsArray = function(tagsArray)
				{
					var result = '';
					for (var i = 0; i < tagsArray.length; ++i)
					{
						result += frame.Star.getById(tagsArray[i]).content + '\r\n';
					}
					return result;
				}

				for (var i = 0; i < starLines.length; ++i)
				{
					var lineLength = starLines[i].length;
					for (var j = 0; j < lineLength; ++j)
					{
						var starView = document.createElement('button');
						var star = starLines[i][j];
						starView.value = star.id;
						starView.tags = star.tags;
						starView.title = getReadableTagsArray(star.tags);
						starView.textContent = star.content;
						starView.onclick = toggleStarSelection;
						starFieldView.appendChild(starView);
					}
					starFieldView.appendChild(document.createElement('br'));
					starFieldView.appendChild(document.createElement('br'));
				}

				// >> // fill star list

				var starListView = document.getElementById('starList');

				// clear div content
				while (starListView.firstChild)
				{
					starListView.removeChild(starListView.firstChild);
				}

				// fill one by one
				var toggleStarTag = function()
				{
					var selectionView = document.getElementById('selectedStar');
					if (selectionView.value)
					{
						if (frame.Star.Tags.contains(selectionView.value, this.value))
						{
							frame.Star.Tags.remove(selectionView.value, this.value);
						}
						else
						{
							frame.Star.Tags.add(selectionView.value, this.value);
						}
						selectionView.tags = frame.Star.Tags.getArray(selectionView.value);
						refreshTagsColors();
					}
				}

				for (var i = 0; i < stars.length; ++i)
				{
					var starView = document.createElement('button');
					var star = stars[i];
					starView.value = star.id;
					starView.tags = star.tags;
					starView.title = getReadableTagsArray(star.tags);
					starView.textContent = star.content;
					starView.onclick = toggleStarTag;
					starListView.appendChild(starView);
					starListView.appendChild(document.createElement('br'));
				}
			}

			function clearFrame()
			{
				clearSelection();
				frame.clear();
				refreshFrame();
			}
		</script>
	</body>
</html>