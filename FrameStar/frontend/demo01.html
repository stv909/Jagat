<!DOCTYPE html>
<html>
	<head>
		<title>Frame-Star Demo01</title>
		<script src="core/FrameStar.js"></script>
	</head>
	<body>
		<div id="starControl" style="width:100%; text-align:center">
			<input id="newStarContent" type="text" name="starContent" onkeyup="handleInputEnter(event);" />
			<button onClick = "var elem = document.getElementById('newStarContent'); elem.focus(); elem.value = '';">
				X
			</button>
			<button onClick = "var elem = document.getElementById('newStarContent'); elem.focus(); createStar(elem.value);">
				Create Star
			</button>
		</div>

		<div id="globalOperations" style="width:100%; text-align:right;">
			<button onClick = "clearFrame();">
				Clear Frame
			</button>
			<br>
			<button onClick = "refreshStarList(); refreshStarField();">
				Refresh Frame
			</button>
		</div>

		<div style="width:100%;">
			<div style="float:left; width:15%;">
				<div id="selectionPanel">
					Selection:<br>
					<button id="selectedStar" onClick="clearSelection();">
					<button id="selectedStar_Edit" onClick="editStarContent();">
						E
					</button>
					<button id="selectedStar_ClearTags" onClick="clearStarTags(document.getElementById('selectedStar').starDesc.id);">
						0
					</button>
					<button id="selectedStar_Delete" onClick="destroyStar(document.getElementById('selectedStar').starDesc.id);">
						X
					</button>
				</div>
				<div>
					Star List:
				</div>
				<div id="starList">
				</div>
			</div>
			<div id="starField" style="float:right; width:85%; white-space:nowrap;">
			</div>
		</div>

		<script>
			var frame = new Frame();
			var shadowStarIds = {};

			function handleInputEnter(event)
			{
				if (event.keyCode === 13)
				{
					createStar(document.getElementById('newStarContent').value);
				}
			}

			function createStar(content)
			{
				var newStar = frame.Star.create();
				newStar.content = content;
				refreshStarList();
				refreshStarField();
			}

			function destroyStar(starId)
			{
				if (!starId)
					return;
				var button = document.getElementById('selectedStar');
				if (button.starDesc.id == starId)
				{
					clearSelection();
				}
				frame.Star.destroy(starId);
				refreshStarList();
				refreshStarField();
			}

			function editStarContent()
			{
				var button = document.getElementById('selectedStar');
				var newContent = prompt("Enter new content:", button.textContent);
				frame.Star.getById(button.starDesc.id).content = newContent;
				button.textContent = newContent;
				refreshStarList();
				refreshStarField();
			}

			function refreshTagsColors()
			{
				var selectionView = document.getElementById('selectedStar');

				var starListView = document.getElementById('starList');
				for (var i = 0; i < starListView.children.length; ++i)
				{
					if (!starListView.children[i].starDesc)
						continue;
					var color = '#e0e0e0';
					if (selectionView.starDesc)
					{
						for (var j = 0; j < selectionView.starDesc.tags.length; ++j)
						{
							if (selectionView.starDesc.tags[j] === starListView.children[i].starDesc.id)
							{
								color = '#0fbd0f';
								break;
							}
						}
					}
					starListView.children[i].style.backgroundColor = color;
				}
			}

			var colorStarSelected = '#4cbdbd';

			function refreshSelectionHighlight()
			{
				var selectionView = document.getElementById('selectedStar');

				var starFieldView = document.getElementById('starField');
				for (var i = 0; i < starFieldView.children.length; ++i)
				{
					if (!starFieldView.children[i].starDesc)
						continue;
					var color = '#e0e0e0';
					if (selectionView.starDesc && selectionView.starDesc.id === starFieldView.children[i].starDesc.id)
					{
						color = colorStarSelected;
					}
					starFieldView.children[i].selectSubButton.style.backgroundColor = color;
				}
			}

			function clearStarTags(starId)
			{
				frame.Star.Tags.clear(starId);
				document.getElementById('selectedStar').starDesc.tags = [];
				refreshTagsColors();
				refreshStarField();
			}

			function clearSelection()
			{
				var selectionView = document.getElementById('selectedStar');
				selectionView.starDesc = null;
				selectionView.textContent = '';
				refreshTagsColors();
				refreshSelectionHighlight();
			}

			var getReadableTagsArray = function(tagsArray)
			{
				var result = '';
				for (var i = 0; i < tagsArray.length; ++i)
				{
					result += frame.Star.getById(tagsArray[i]).content + '\r\n';
				}
				return result;
			}

			function refreshStarList()
			{
				var stars = frame.Star.getArray();

				// >> // fill star list

				var starListView = document.getElementById('starList');

				// clear div content
				while (starListView.firstChild)
				{
					starListView.removeChild(starListView.firstChild);
				}

				// fill one by one
				var toggleStarTag = function()
				{
					var selectionView = document.getElementById('selectedStar');
					if (selectionView.starDesc)
					{
						if (frame.Star.Tags.contains(selectionView.starDesc.id, this.starDesc.id))
						{
							frame.Star.Tags.remove(selectionView.starDesc.id, this.starDesc.id);
						}
						else
						{
							frame.Star.Tags.add(selectionView.starDesc.id, this.starDesc.id);
						}
						selectionView.starDesc.tags = frame.Star.Tags.getArray(selectionView.starDesc.id);
						refreshTagsColors();
						refreshStarField();
					}
				}

				for (var i = 0; i < stars.length; ++i)
				{
					var starView = document.createElement('button');
					starView.starDesc = stars[i];
					starView.textContent = starView.starDesc.content;
					starView.onclick = toggleStarTag;
					starListView.appendChild(starView);
					starListView.appendChild(document.createElement('br'));
				}
				refreshTagsColors();
			}

			function refreshStarField()
			{
				var stars = frame.Star.getArray();

				// >> // fill star field

				// clear div content
				var starFieldView = document.getElementById('starField');
				while (starFieldView.firstChild)
				{
					starFieldView.removeChild(starFieldView.firstChild);
				}

				// sort stars by vertical lines
				var starLines = [];
				// first line - stars with no tags
				// second line - stars have tags only from first line
				// third line - stars have tags only from first or second line
				// etc.
				var starsToTest = stars;
				while (starsToTest.length > 0)
				{
					var priorLength = starsToTest.length;
					var currentLine = [];
					var concreteStars = [];
					for (var i = 0; i < starsToTest.length; ++i)
					{
						var star = starsToTest[i];
						var isConcrete = false;
						for (var t = 0; t < star.tags.length; ++t)
						{
							var tag = star.tags[t];
							var tagFound = false;
							for (var j = 0; j < starsToTest.length; ++j)
							{
								if (tag === starsToTest[j].id)
								{
									tagFound = true;
									break;
								}
							}
							if (tagFound)
							{
								isConcrete = true;
								break;
							}
						}
						if (isConcrete)
						{
							concreteStars.push(star);
						}
						else
						{
							currentLine.push(star);
						}
					}
					starLines.push(currentLine);
					starsToTest = concreteStars;
					if (priorLength === starsToTest.length)
					{
						console.log('WARNING: endless loop detected. force break.');
						break;
					}
				}

				// sort each lines by horizontal order

				// fill div with sorted content

				var toggleStarSelection = function()
				{
					if (this.style.backgroundColor == 'rgb(76, 189, 189)')
					{
						clearSelection();
					}
					else
					{
						var selectionView = document.getElementById('selectedStar');
						selectionView.starDesc = this.parentNode.starDesc;
						selectionView.textContent = this.parentNode.starDesc.content;
					}
					refreshTagsColors();
					refreshSelectionHighlight();
				}

				var toggleStarFilterring = function()
				{
					if (this.parentNode.hide)
					{
						delete shadowStarIds[this.parentNode.starDesc.id];
					}
					else
					{
						shadowStarIds[this.parentNode.starDesc.id] = true;
					}
					refreshStarList();
					refreshStarField();
				}

				var hiddenStarIds = {};

				for (var i = 0; i < starLines.length; ++i)
				{
					var lineLength = starLines[i].length;
					for (var j = 0; j < lineLength; ++j)
					{
						var currentStar = starLines[i][j];
						var skipStar = false;
						if (currentStar.tags.length > 0)
						{
							skipStar = true;
							for (var k = 0; k < currentStar.tags.length; ++k)
							{
								var currentTagId = currentStar.tags[k];
								if (!(currentTagId in shadowStarIds || currentTagId in hiddenStarIds))
								{
									skipStar = false;
									break;
								}
							}
						}
						if (skipStar)
						{
							hiddenStarIds[currentStar.id] = true;
							continue;
						}

						var starView = document.createElement('button');
						starView.starDesc = currentStar;
						starView.disabled = true;

						var starContentView = document.createElement('button');
						starContentView.title = getReadableTagsArray(starView.starDesc.tags);
						starContentView.textContent = starView.starDesc.content;
						starContentView.onclick = toggleStarFilterring;
						if (starView.starDesc.id in shadowStarIds)
						{
							starView.hide = true;
							starContentView.style.backgroundColor = '#999999';
						}

						var starSelectView = document.createElement('button');
						starSelectView.textContent = 'S';
						starSelectView.onclick = toggleStarSelection;

						starView.contentSubButton = starContentView;
						starView.selectSubButton = starSelectView;
						starView.appendChild(starContentView);
						starView.appendChild(starSelectView);
						starFieldView.appendChild(starView);
					}
					starFieldView.appendChild(document.createElement('br'));
					//starFieldView.appendChild(document.createElement('br'));
				}
				refreshSelectionHighlight();
			}

			function clearFrame()
			{
				clearSelection();
				frame.clear();
				refreshStarList();
				refreshStarField();
			}
		</script>
	</body>
</html>