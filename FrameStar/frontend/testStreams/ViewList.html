<!DOCTYPE html>
<html>
	<head>
		<title>Frame View. List.</title>
		<script src="../coreStreams/Content.js"></script>
		<script src="../coreStreams/Frame.js"></script>
		<script>
			var colorInactive = '#eeeeee';
			var colorSelected = '#8888ff';
			var frame = new Frame();

			var selectedNode = new function()
			{
				var uuid = null;
				var control = null;

				this.get = function()
				{
					return uuid;
				};

				this.getAtom = function()
				{
					// TODO: implement returning proper index from radio group
					return 0;
				};

				this.set = function(newUuid, newControl)
				{
					if (control)
					{
						control.style.background = colorInactive;
					}
					uuid = newUuid;
					control = newControl;
					if (control)
					{
						control.style.background = colorSelected;
					}
				};

				this.reset = function()
				{
					this.set(null, null);
				};
			};

			function refreshList(nodeViewContainer)
			{
				var frameControl = new FrameControl(frame);
				nodeViewContainer.innerHTML = '';
				selectedNode.reset(); // TODO: implement saving selection after refreshing.

				var matrix = frameControl.getMatrix();
				for (var nodeId in matrix)
				{
					var nodeControl = frameControl.getNodeControl(nodeId);
					var nodeButton = document.createElement('button');
					var captionHTML = '';
					var imax = nodeControl.getAtomsCount();
					for (var i = 0; i < imax; ++i)
					{
						captionHTML +=
						'<input type="radio" name="' + nodeId + '" value="' + i + '"' +
						(i === 0 ? ' checked>' : '>') +
						nodeControl.getAtomControl(i).getContent() +
						'<br>';
					}
					nodeButton.style.background = colorInactive;
					nodeButton.onclick = function(currentNodeId, currentNodeButton)
					{
						return function()
						{
							if (selectedNode.get() != currentNodeId)
							{
								selectedNode.set(currentNodeId, currentNodeButton);
							}
							else
							{
								selectedNode.set(null, null);
							}
						};
					}(nodeId, nodeButton);
					nodeButton.innerHTML = captionHTML;
					nodeViewContainer.appendChild(nodeButton);
					nodeViewContainer.appendChild(document.createElement('br'));
				}
			}

			function onClickLoadJSON(nodeList, source)
			{
				var initNodes;
				try
				{
					initNodes = JSON.parse(source.value).nodes;
				}
				catch (e)
				{
					console.log('Can not parse given content string as JSON. String: ' + source + '; Name: ' + e.name + '; Desc: ' + e.message);
					initNodes = {};
				}
				frame = new Frame(initNodes);
				refreshList(nodeList);
			}

			function onClickSaveJSON(destination)
			{
				var frameControl = new FrameControl(frame);
				destination.value = frameControl.stringify();
			}

			function onClickNewNode(nodeList)
			{
				var frameControl = new FrameControl(frame);
				frameControl.add();
				refreshList(nodeList);
			}

			function onClickDelNode(nodeList)
			{
				if (selectedNode.get() === null)
					return;
				var frameControl = new FrameControl(frame);
				frameControl.remove(selectedNode.get());
				refreshList(nodeList);
			}

			function onClickNewAtom(nodeList)
			{
				if (selectedNode.get() === null)
					return;
				var frameControl = new FrameControl(frame);
				var nodeControl = frameControl.getNodeControl(selectedNode.get());
				if (nodeControl === null)
					return;
				nodeControl.add();
				refreshList(nodeList);
			}

			function onClickRenameAtom(nodeList)
			{
				if (selectedNode.get() === null)
					return;
				var frameControl = new FrameControl(frame);
				var nodeControl = frameControl.getNodeControl(selectedNode.get());
				if (nodeControl === null)
					return;
				var atomControl = nodeControl.getAtomControl(selectedNode.getAtom());
				if (atomControl === null)
					return;
				atomControl.setContent('new atom name'); // TODO: implement real renaming!
				refreshList(nodeList);
			}

			function onClickAtomAbstract(nodeList)
			{
				alert(nodeList);
			}

			function onClickAtomConcrete(nodeList)
			{
				alert(nodeList);
			}

			function onClickDelAtom(nodeList)
			{
				alert(nodeList);
			}
		</script>
	</head>
	<body>
		<div id="frameView">
			<div id="commands">
				<button onclick="onClickNewNode(document.getElementById('nodeList'));">new node</button>
				<button onclick="onClickDelNode(document.getElementById('nodeList'));">del node</button>
				;
				<button onclick="onClickNewAtom(document.getElementById('nodeList'));">new atom</button>
				<button onclick="onClickRenameAtom(document.getElementById('nodeList'));">rename atom</button>
				<button onclick="onClickAtomAbstract(document.getElementById('nodeList'));">atom set abstracts</button>
				<button onclick="onClickAtomConcrete(document.getElementById('nodeList'));">atom set concretes</button>
				<button onclick="onClickDelAtom(document.getElementById('nodeList'));">del atom</button>
				;
				<textarea id="loadInput"></textarea>
				<button onclick="onClickLoadJSON(document.getElementById('nodeList'), document.getElementById('loadInput'));">load from JSON</button>
				;
				<textarea id="saveOutput"></textarea>
				<button onclick="onClickSaveJSON(document.getElementById('saveOutput'));">save to JSON</button>
			</div>
			<div><br></div>
			<div id="nodeList">
			</div>
		</div>
	</body>
</html>